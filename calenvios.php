<?php
/**
Plugin Name: CalEnvios
Plugin URI: https://github.com/Yoseph-Reyes/plugWP-CalEnv
Description: Plugin de WordPress para calcular el costo de un envio en Woocommerce a cualquier direccion
Version: 1.0
Author: Yoseph Reyes
Author URI: https://github.com/Yoseph-Reyes
Text Domain: cenv
Generated By: http://ensuredomains.com
License: Pendiente puede ser MIT
*/
if ( ! defined( 'WPINC' ) ) {
 
    die;
 
}
header("Content-Type: application/javascript");
 
/*
 * Check if WooCommerce is active
 */
if ( in_array( 'woocommerce/woocommerce.php', apply_filters( 'active_plugins', get_option( 'active_plugins' ) ) ) ) {
 
    
	add_action('woocommerce_before_shipping_calculator','add_form',1);

	function add_form(){
		echo "<form action='' class='formGetAdress' id='form2' method='post' name='calc_shipping'>";
        echo "<label for=''>ZIPCODE:</label>";
        echo     "<input type='text' name='form_zipcode'><br>";
        echo     "<label for=''>CITY:</label>";
        echo     "<input type='text' name='form_city'><br>";
        echo     "<label for=''>State:</label>";
        echo     "<input type='text' name='form_state'><br>";            
        echo     "<label for=''>COUNTRY:</label>";
        echo     "<select name= 'form_country'>";
        echo         "<option value='USA'> United States</option>";
        echo         "<option value='CAN'> Canada</option>";
        echo     "</select><br>";            
        echo     "<button type='submit' name='form__submit'>mirar</button>";            
		echo "</form>";

		
			global $woocommerce;
			$items = $woocommerce->cart->get_cart();
			$length = 0;
			$width = 0; 
			$height = 0;
			$weigth = 0;
			global $CrtCharge, $Crtdelivery , $StdCharge , $Stddelivery , $AclCharge , $Acldelivery;
	
			//LOOP ALL THE PRODUCTS IN THE CART
			foreach($items as $item => $values) { 
				$_product =  wc_get_product( $values['data']->get_id());
				//GET GET PRODUCT DIMENSIONS 
				$length = $length + $_product->get_length();  
				$width  = $width  + $_product->get_width();  
				$height = $height + $_product->get_height();
				$weigth = $weigth + $_product->get_weight();
				//VARIABLES PARA IMPRIMIR
				/*echo 'largo '.$length. '<br>';
				echo 'ancho '. $width. '<br>';
				echo 'Alto '. $height. '<br>';
				echo 'Peso '. $weigth. '<br>';*/
				
			} 
		
	
		echo '<script>';
		echo '"use strict";';        
		echo 'function Postday (){';
		
		echo 'const hoy = new Date();';
		echo 'const hoyMediaNoche= new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());';
		echo 'if (hoy.getDay()=== 1 || hoy.getDay()=== 2 || hoy.getDay()=== 3  || hoy.getDay()=== 4 || hoy.getDay() === 7){';
		echo '	hoyMediaNoche.setDate(hoy.getDate() + parseInt(1));';
		echo '}  else if (hoy.getDay() === 5){';
		echo '	hoyMediaNoche.setDate(hoy.getDate() + parseInt(3));';
		echo '} else {';
		echo '	hoyMediaNoche.setDate(hoy.getDate() + parseInt(2));';
		echo '}';
		echo 'const dia = hoyMediaNoche.getDate();';
		echo 'const mes = hoyMediaNoche.getMonth()+1;';
		echo 'const ano = hoyMediaNoche.getFullYear();';

		echo 'console.log(hoyMediaNoche.getDate());';
		echo 'if(hoyMediaNoche.getDate()>9){';
		echo 'return (String(ano)+"0"+String(mes)+String(dia));';
			
		echo '} else{';
		echo 'return (String(ano)+"0"+String(mes)+"0"+String(dia));';
		echo '}';
		echo '}';
		echo 'const diaparametro= Postday ();';

		echo 'function AclValidate(Charge, Delivery){';
		echo 'if (isNaN(Charge)){';

		echo "return(";
		echo "`<p>Faster?: Call us</p>`";
		echo ")}else{";
		echo "const ChargeInt= (parseInt(Charge))/100;";
		echo "const DeliveryString= String(Delivery);";
		echo "return(`";
		echo "<p>Delivery Date: ${DeliveryString.substr(0,4)}/${DeliveryString.substr(4,2)}/${DeliveryString.substr(6,2)}</p>";
		echo "<h3>Faster: ${ChargeInt} USD</h3><br>";
		echo "`);";
		echo "}";
		echo "}";



		echo 'function Answertemplate(data){';
		echo 'const CrtCharge   = (parseInt(data[0].totalCharges))/100;';
		echo 'const Crtdelivery =  String(data[0].deliveryDate);';
		echo 'const StdCharge   = (parseInt(data[2].totalCharges))/100;';
		echo 'const Stddelivery =  String(data[2].deliveryDate);';
		echo 'const AclCharge   = data[1].totalCharges;';
		echo 'const Acldelivery =  data[1].deliveryDate;';
		echo 'console.log (AclCharge);';
		echo 'console.log (Acldelivery);';
		echo 'console.log(typeof(Acldelivery));';
		echo 'const AclValidateString= AclValidate (AclCharge, Acldelivery);';
		echo "return (";
		echo "`<h2>Quote:</h2>";
		echo "<p>Delivery Date: ${Stddelivery.substr(0,4)}/${Stddelivery.substr(4,2)}/${Stddelivery.substr(6,2)}</p>";
		echo "<h3>Standar: ${StdCharge} USD</h3><br>";
		echo "<p>Delivery Date: ${Crtdelivery.substr(0,4)}/${Crtdelivery.substr(4,2)}/${Crtdelivery.substr(6,2)}</p>";
		echo "<h3>Critical: ${CrtCharge} USD</h3><br>;";
		echo "${AclValidateString};";
		echo "`";
		echo ");";
		echo "}";


			
		echo "const form2 = document.getElementById('form2');";
		echo "console.log(form2);";
		echo "form2.addEventListener('submit', (event)=>{";	
		echo "event.preventDefault(); 
		const formLlenado2 = new FormData (form2);
		const form_zipcode2  = formLlenado2.get('form_zipcode');
		const form_city2  = formLlenado2.get('form_city');
		const form_country2  = formLlenado2.get('form_country')
		const form_state2  = formLlenado2.get('form_state');";
			


		echo 'var data ={';
		echo 'login: {';
		echo 'username: "storagecanopy",';
		echo 'password: "yrc1234",';
		echo 'busId: "78026298937",';
		echo 'busRole: "Shipper",';
		echo 'paymentTerms: "Prepaid"';
		echo '},';
		echo 'details: {';
		echo 'serviceClass: "ALL",';
		echo 'typeQuery: "MATRX",';
		echo 'pickupDate: diaparametro,';
		echo 'productCode: "DFQ",';
		echo 'acceptTerms: true';
		echo '},';
		echo 'originLocation: {';
		echo 'city: "Venus",';
		echo 'state: "FL",';
		echo 'postalCode: "33960",';
		echo 'country: "USA",';
		echo 'locationType: "COMM"    ';
		echo '},';
		echo 'destinationLocation: {';
		echo 'city: form_city2,';
		echo 'state: form_state2,';
		echo 'postalCode: form_zipcode2,  ';
		echo 'country: form_country2,';
		echo 'locationType: "COMM"  ';
		echo '},';
		echo 'listOfCommodities: {';
		echo 'hazmatInd: false,';
		echo 'poisonInd: false,';
		echo 'commodity: [';
		echo '{';
		echo 'handlingUnits: 1,';
		echo 'packageCode: "SKD",';
		echo 'packageLength:'.$length.',';
		echo 'packageWidth:'.$width .',';
		echo 'packageHeight:'.$height.',';
		echo 'weight:'.$weigth.'';
		echo '}]';
		echo '},';			
		echo '};';

		echo "console.log(diaparametro);";

		echo " async function GetUserApi(){
            let response = await fetch ('https://api.yrc.com/node/api/ratequote',{
                method :'POST',
                body:JSON.stringify(data),
                headers:{
                    'Content-Type': 'application/json'
                    }
                });
            let data2 = await response.json();
            return data2;

            }

            GetUserApi().
            then(recibido=>{
              console.log(recibido); 
              var cargoTotal=recibido.pageRoot.bodyMain.rateQuote.quoteMatrix.table[0].transitOptions;
              const StdCharge = (parseInt(cargoTotal[2].totalCharges))/100;
              const CrtCharge = (parseInt(cargoTotal[0].totalCharges))/100;
              console.log(StdCharge);
              console.log($form_state);
              window.location.href = window.location.href + '?w1= '+ StdCharge  + '&w2= '+  CrtCharge;


              let htmlString = Answertemplate(cargoTotal)
              var prueba= 'hola soy javascript';
              const answer = document.getElementById('answer')
              answer.innerHTML= htmlString
            })



              
            })
           


        </script>";?>

        <?php
          
          if (isset($_GET["w1"]) && isset($_GET["w2"])) {
            // asignar w1 y w2 a dos variables
            $phpVar1 = $_GET["w1"];
            $phpVar2 = $_GET["w2"];
           
         
            // mostrar $phpVar1 y $phpVar2
            echo "<p>Parameters: " . $phpVar1 . "y el otro valor". $phpVar2. "</p>";
        } else {
            echo "<p>No parameters</p>";
        }
         
        
		
		
		
	}
	
	

	add_filter( 'woocommerce_package_rates',  'modify_shipping_rate', 15, 2 );
	function modify_shipping_rate( $available_shipping_methods, $package ){

    global $woocmmerce;
    //$total_weight = WC()->cart->cart_contents_weight;
    //$total_coast = WC()->cart->get_cart_contents_total();
	$available_shipping_methods['ENVIO NORMAL:1']->cost = $StdCharge;
	$available_shipping_methods['ENVIO EXPRESS:1']->cost = $CrtCharge;

    return $available_shipping_methods;
}
	
	
	

		
	//HOOK PARA VISUALIZAR DIMENSIONES EN LA PAGINA PRINCIPAL

	add_action( 'woocommerce_after_shop_loop_item', 'show_product_dimensions_loop', 20 );
  
	function show_product_dimensions_loop() {
   		global $product;
		$dimensions = $product->get_dimensions();
		if ( ! empty( $dimensions ) ) {
			echo '<div class="dimensions"><b>Height:</b> ' . $product->get_height() . ' in';
			echo '<br><b>Width:</b> ' . $product->get_width() . ' in';
			echo '<br><b>Length:</b> ' . $product->get_length() . ' in';
			echo '<br><b>Weight:</b> ' . $product->get_weight() .' lbs';
			echo '</div>';        
		}
	}

}?>